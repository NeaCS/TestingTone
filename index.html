<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Generador Ambient Infinito ‚Äî Con Visualizador</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <script>
    let running = false;
    let audioContext;
    let synths = {};
    let noises = {};
    let volumes = {};
    let filters = {};
    let reverb;
    let timeouts = [];

    const state = {
      volumes: { drone: 0.3, pads: 0.2, bells: 0.15, plucks: 0.1, wind: 0.15, water: 0.12, birds: 0.08, master: 0.5 },
      reverbWet: 0.9,
      reverbDecay: 14,
      bpm: 55,
      density: 50,
      probPluck: 30,
      probBirds: 20,
      padBrightness: 40,
      globalLowpass: 20000
    };

    const scale = ["C3","D#3","F3","G3","A#3","C4","D#4","F4"];

    function randFrom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function densityMultiplier() {
      const d = state.density / 100;
      return 2.0 - 1.7 * d;
    }

    function dbToLinear(db) {
      return Math.pow(10, db / 20);
    }

    // Analizador para visualizaci√≥n (se inicializa en initAudio)
    let analyserFFT = null;

    async function initAudio() {
      audioContext = Tone.context;
      
      // Reverb
      reverb = new Tone.Reverb({
        decay: state.reverbDecay,
        wet: state.reverbWet
      }).toDestination();
      await reverb.generate();

      // Drone
      synths.drone = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 8, release: 8 }
      }).connect(reverb);

      // Pads
      synths.pads = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sine" },
        envelope: { attack: 5, release: 8 }
      }).connect(reverb);

      // Bells
      synths.bells = new Tone.MetalSynth({
        frequency: 200,
        envelope: { attack: 0.001, decay: 1, release: 3 },
        harmonicity: 5.1,
        modulationIndex: 32,
        resonance: 4000,
        octaves: 1.5
      }).connect(reverb);

      // Plucks
      synths.plucks = new Tone.PluckSynth({
        attackNoise: 1,
        dampening: 4000,
        resonance: 0.7
      }).connect(reverb);

      // Wind (ruido rosa filtrado)
      noises.wind = new Tone.Noise("pink").start();
      filters.wind = new Tone.Filter({
        type: "lowpass",
        frequency: 800,
        rolloff: -24
      }).connect(reverb);
      noises.wind.connect(filters.wind);
      noises.wind.volume.value = -20;

      // Water (ruido filtrado)
      noises.water = new Tone.Noise("pink").start();
      filters.water = new Tone.Filter({
        type: "bandpass",
        frequency: 1500,
        Q: 3
      }).connect(reverb);
      noises.water.connect(filters.water);
      noises.water.volume.value = -22;

      // Birds synth
      synths.birds = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.4 }
      }).connect(reverb);

      // Vol√∫menes iniciales (mantengo tu enfoque con Tone.gainToDb)
      if (synths.drone) synths.drone.volume.value = Tone.gainToDb(state.volumes.drone);
      if (synths.pads) synths.pads.volume.value = Tone.gainToDb(state.volumes.pads);
      if (synths.bells) synths.bells.volume.value = Tone.gainToDb(state.volumes.bells);
      if (synths.plucks) synths.plucks.volume.value = Tone.gainToDb(state.volumes.plucks);
      if (synths.birds) synths.birds.volume.value = Tone.gainToDb(state.volumes.birds);
      if (noises.wind) noises.wind.volume.value = Tone.gainToDb(state.volumes.wind);
      if (noises.water) noises.water.volume.value = Tone.gainToDb(state.volumes.water);
      
      Tone.Master.volume.value = Tone.gainToDb(state.volumes.master);

      // ---------------------------
      // Analizador FFT para visualizador
      // ---------------------------
      analyserFFT = new Tone.Analyser("fft", 256);
      // Conecto tanto la salida de reverb (efecto) como Master para tener buena referencia
      reverb.connect(analyserFFT);
      Tone.Master.connect(analyserFFT);

      // Inicializo visualizador aqu√≠ para que est√© listo cuando empieces
      initVisualizer();
    }

    function playDrone() {
      if (!running || !synths.drone) return;
      synths.drone.triggerAttack("C2");
    }

    function playRandomPad() {
      if (!running) return;
      const howMany = 1 + Math.floor(Math.random() * 3);
      const notes = Array.from({length: howMany}, () => randFrom(scale));
      const dur = Math.max(4, Math.round(12 * densityMultiplier()));
      synths.pads.triggerAttackRelease(notes, dur);
      
      const next = (10 + Math.random() * 10) * densityMultiplier() * 1000;
      timeouts.push(setTimeout(playRandomPad, next));
    }

    function playRandomBell() {
      if (!running) return;
      const note = randFrom(scale);
      const freq = Tone.Frequency(note).toFrequency();
      synths.bells.frequency.value = freq;
      synths.bells.triggerAttackRelease(0.3);
      
      const next = (8 + Math.random() * 12) * densityMultiplier() * 1000;
      timeouts.push(setTimeout(playRandomBell, next));
    }

    function playRandomPluck() {
      if (!running) return;
      if (Math.random() * 100 < state.probPluck) {
        const note = randFrom(scale);
        synths.plucks.triggerAttack(note);
      }
      const next = (4 + Math.random() * 6) * densityMultiplier() * 1000;
      timeouts.push(setTimeout(playRandomPluck, next));
    }

    function playRandomBirds() {
      if (!running) return;
      if (Math.random() * 100 < state.probBirds) {
        const freq = 1000 + Math.random() * 2000;
        synths.birds.triggerAttackRelease(freq, "16n");
      }
      const next = (10 + Math.random() * 20) * densityMultiplier() * 1000;
      timeouts.push(setTimeout(playRandomBirds, next));
    }

    async function startAmbient() {
      if (running) return;
      
      await Tone.start();
      
      if (!synths.drone) {
        await initAudio();
      }
      
      running = true;
      document.getElementById("playBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;

      Tone.Transport.bpm.value = state.bpm;
      
      playDrone();
      playRandomPad();
      playRandomBell();
      playRandomPluck();
      playRandomBirds();
      
      Tone.Transport.start();
    }

    function stopAmbient() {
      if (!running) return;
      running = false;
      
      document.getElementById("playBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;

      timeouts.forEach(t => clearTimeout(t));
      timeouts = [];

      try { Tone.Transport.stop(); } catch(e) {}
      try { synths.drone.triggerRelease(); } catch(e) {}
      try { synths.pads.releaseAll(); } catch(e) {}
    }

    function setupSlider(id, callback, initValue) {
      const container = document.getElementById(id);
      const slider = container.querySelector("input");
      const display = container.querySelector(".value");
      
      slider.value = initValue;
      display.textContent = initValue;
      
      slider.addEventListener("input", (e) => {
        const val = parseFloat(e.target.value);
        display.textContent = val;
        callback(val);
      });
    }

    function setupUI() {
      // Vol√∫menes (0-1 linear)
      setupSlider("s-drone", (v) => {
        state.volumes.drone = v;
        if (synths.drone) synths.drone.volume.value = Tone.gainToDb(v);
      }, state.volumes.drone);

      setupSlider("s-pads", (v) => {
        state.volumes.pads = v;
        if (synths.pads) synths.pads.volume.value = Tone.gainToDb(v);
      }, state.volumes.pads);

      setupSlider("s-bells", (v) => {
        state.volumes.bells = v;
        if (synths.bells) synths.bells.volume.value = Tone.gainToDb(v);
      }, state.volumes.bells);

      setupSlider("s-plucks", (v) => {
        state.volumes.plucks = v;
        if (synths.plucks) synths.plucks.volume.value = Tone.gainToDb(v);
      }, state.volumes.plucks);

      setupSlider("s-wind", (v) => {
        state.volumes.wind = v;
        if (noises.wind) noises.wind.volume.value = Tone.gainToDb(v);
      }, state.volumes.wind);

      setupSlider("s-water", (v) => {
        state.volumes.water = v;
        if (noises.water) noises.water.volume.value = Tone.gainToDb(v);
      }, state.volumes.water);

      setupSlider("s-birds", (v) => {
        state.volumes.birds = v;
        if (synths.birds) synths.birds.volume.value = Tone.gainToDb(v);
      }, state.volumes.birds);

      setupSlider("s-master", (v) => {
        state.volumes.master = v;
        Tone.Master.volume.value = Tone.gainToDb(v);
      }, state.volumes.master);

      // Reverb
      setupSlider("s-reverb-wet", (v) => {
        state.reverbWet = v / 100;
        if (reverb) reverb.wet.value = state.reverbWet;
      }, state.reverbWet * 100);

      setupSlider("s-reverb-decay", (v) => {
        state.reverbDecay = v;
        if (reverb) reverb.decay = state.reverbDecay;
      }, state.reverbDecay);

      // Tempo
      setupSlider("s-bpm", (v) => {
        state.bpm = v;
        Tone.Transport.bpm.value = state.bpm;
      }, state.bpm);

      // Density
      setupSlider("s-density", (v) => {
        state.density = v;
      }, state.density);

      // Probabilidades
      setupSlider("s-prob-pluck", (v) => {
        state.probPluck = v;
      }, state.probPluck);

      setupSlider("s-prob-birds", (v) => {
        state.probBirds = v;
      }, state.probBirds);

      // Botones
      document.getElementById("playBtn").addEventListener("click", startAmbient);
      document.getElementById("stopBtn").addEventListener("click", stopAmbient);
      document.getElementById("resetBtn").addEventListener("click", () => location.reload());
    }

    // Inicializaci√≥n UI
    window.addEventListener("DOMContentLoaded", () => {
      setupUI();
      document.getElementById("stopBtn").disabled = true;
    });

    /* ---------------------------
       VISUALIZADOR: Multicolor, Burbujas, Modos
       Se integra con `analyserFFT` creado en initAudio (arriba)
       --------------------------- */
    let canvas, ctxVis;
    let visMode = "rainbow"; // rainbow | bubbles | lines
    let particles = [];

    function initVisualizer() {
      // Crear canvas en el DOM (si no existe)
      canvas = document.getElementById("visualizer-canvas");
      ctxVis = canvas.getContext("2d");

      function resizeVis() {
        // mantener DPR para nitidez
        const dpr = window.devicePixelRatio || 1;
        canvas.width = canvas.offsetWidth * dpr;
        canvas.height = canvas.offsetHeight * dpr;
        ctxVis.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      window.addEventListener("resize", resizeVis);
      resizeVis();

      // inicializar part√≠culas para burbujas
      particles = Array.from({length: 40}, (_, i) => ({
        x: Math.random(),
        y: Math.random(),
        r: 2 + Math.random()*4,
        vx: (Math.random()-0.5)*0.002,
        vy: (Math.random()-0.5)*0.002,
        hueOffset: Math.random()*360
      }));

      requestAnimationFrame(drawVisualizer);
    }

    // Helper color
    function hueColor(i, alpha=1) {
      return `hsla(${(i*7)%360}, 80%, 60%, ${alpha})`;
    }

    function drawVisualizer() {
      requestAnimationFrame(drawVisualizer);
      if (!analyserFFT || !ctxVis) return;

      // obtener datos FFT (array de floats)
      const fft = analyserFFT.getValue();
      if (!fft || fft.length === 0) return;

      const w = canvas.offsetWidth;
      const h = canvas.offsetHeight;
      ctxVis.clearRect(0, 0, w, h);

      // normalizar values 0..1 (fft values suelen ser -140..0 dB)
      const norm = fft.map(v => Math.max(0, (v + 140) / 140)); // 0..1

      // calcular energ√≠a global (para burbujas)
      const energy = norm.reduce((a,b)=>a+b,0) / norm.length;

      // background sutil
      ctxVis.fillStyle = "rgba(7,7,10,0.25)";
      ctxVis.fillRect(0,0,w,h);

      if (visMode === "rainbow") {
        // barras arco√≠ris, suave
        const barW = w / norm.length;
        for (let i=0;i<norm.length;i++) {
          const val = norm[i];
          const barH = val * h * 0.7;
          ctxVis.fillStyle = `hsl(${(i/norm.length)*360}, 80%, ${40 + val*30}%)`;
          ctxVis.fillRect(i*barW, h - barH, barW*0.9, barH);
        }
      } else if (visMode === "bubbles") {
        // burbujas reactivas al reverb: tama√±o depende de energy y algunos bins
        const baseSize = 6 + energy * 60;
        for (let i=0;i<particles.length;i++) {
          const p = particles[i];
          // mover con velocidad influida por energy y densidad
          p.x += p.vx * (1 + energy*6) * (1 + state.density/100);
          p.y += p.vy * (1 + energy*6) * (1 + state.density/100);

          if (p.x < 0) p.x = 1;
          if (p.x > 1) p.x = 0;
          if (p.y < 0) p.y = 1;
          if (p.y > 1) p.y = 0;

          // tama√±o modulado por una banda del spectrum
          const bandIdx = Math.floor((i / particles.length) * norm.length);
          const bandVal = norm[bandIdx] || 0;
          const r = baseSize * (0.6 + bandVal*1.6) * (0.5 + Math.random()*0.5);

          const px = p.x * w;
          const py = p.y * h;

          // glow: dibujamos varios c√≠rculos con alpha decreciente
          for (let g = 4; g >= 0; g--) {
            ctxVis.beginPath();
            const alpha = 0.06 * (5 - g) * (0.8 + bandVal*0.8);
            ctxVis.fillStyle = `hsla(${(p.hueOffset + i*5)%360}, 75%, 60%, ${alpha})`;
            ctxVis.arc(px, py, r * (1 + g*0.4), 0, Math.PI*2);
            ctxVis.fill();
          }
        }
      } else if (visMode === "lines") {
        // onda suave usando waveform approximation (convert FFT -> pseudo waveform)
        ctxVis.lineWidth = 2;
        ctxVis.beginPath();
        for (let i=0;i<norm.length;i++) {
          const x = (i/(norm.length-1))*w;
          // crear una "onda" vertical a partir de fft value
          const y = h/2 + (norm[i]-0.5) * h * 0.9;
          if (i===0) ctxVis.moveTo(x,y);
          else ctxVis.lineTo(x,y);
        }
        // gradiente en stroke
        const grad = ctxVis.createLinearGradient(0,0,w,0);
        grad.addColorStop(0, "rgba(110,231,183,0.9)");
        grad.addColorStop(0.5, "rgba(59,130,246,0.9)");
        grad.addColorStop(1, "rgba(236,72,153,0.9)");
        ctxVis.strokeStyle = grad;
        ctxVis.stroke();

        // part√≠culas de energ√≠a que siguen picos
        for (let i=0;i<20;i++) {
          const idx = Math.floor((i/20) * norm.length);
          const v = norm[idx];
          const px = (idx / norm.length) * w;
          const py = h/2 + (v-0.5)*h*0.9;
          ctxVis.beginPath();
          ctxVis.fillStyle = `hsla(${(i*18)%360}, 80%, 60%, ${0.6*v})`;
          ctxVis.arc(px, py, 2 + v*6, 0, Math.PI*2);
          ctxVis.fill();
        }
      }

      // small overlay text (modo + energy)
      ctxVis.fillStyle = "rgba(255,255,255,0.06)";
      ctxVis.font = "12px system-ui, sans-serif";
      ctxVis.fillText(`Modo: ${visMode}    Energ√≠a: ${energy.toFixed(3)}`, 12, 16);
    }

    // Exponer cambio de modo desde el selector de la UI
    function setVisMode(m) {
      visMode = m;
      // reiniciar part√≠culas si se vuelve a bubbles
      if (visMode === "bubbles" && particles.length === 0) {
        particles = Array.from({length: 40}, (_, i) => ({
          x: Math.random(),
          y: Math.random(),
          r: 2 + Math.random()*4,
          vx: (Math.random()-0.5)*0.002,
          vy: (Math.random()-0.5)*0.002,
          hueOffset: Math.random()*360
        }));
      }
    }
  </script>

  <style>
    :root {
      --bg: #07070a;
      --accent: #6ee7b7;
      --muted: #9aa5b1;
      --text: #e6eef3;
    }
    body {
      margin: 0;
      padding: 20px;
      background: radial-gradient(circle at 10% 10%, #071123 0%, var(--bg) 40%);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    h1 { 
      font-size: 24px; 
      margin: 0;
      background: linear-gradient(135deg, var(--accent), #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    p.lead { 
      margin: 4px 0 0 0; 
      color: var(--muted); 
      font-size: 14px; 
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .panel {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    .panel h3 { 
      margin: 0 0 16px 0; 
      font-size: 15px; 
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .slider-row label { 
      min-width: 110px; 
      font-size: 13px; 
      color: var(--muted); 
    }

    .slider-row input[type=range] { 
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: rgba(255,255,255,0.1);
      outline: none;
      -webkit-appearance: none;
    }

    .slider-row input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(110, 231, 183, 0.4);
    }

    .slider-row input[type=range]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(110, 231, 183, 0.4);
    }

    .slider-row .value { 
      min-width: 50px; 
      text-align: right; 
      font-family: 'Courier New', monospace; 
      font-size: 13px; 
      color: var(--text);
      font-weight: 600;
    }

    .big-actions {
      display: flex;
      gap: 10px;
    }

    button.main {
      padding: 12px 24px;
      background: linear-gradient(135deg, #16324a, #0f2330);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    button.main:hover:not(:disabled) {
      background: linear-gradient(135deg, #1e3f5a, #132936);
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    button.main:disabled { 
      opacity: 0.4; 
      cursor: not-allowed; 
    }

    hr {
      border: none;
      border-top: 1px solid rgba(255,255,255,0.06);
      margin: 16px 0;
    }

    footer { 
      margin-top: 24px; 
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.06);
      color: var(--muted); 
      font-size: 13px;
      text-align: center;
    }

    /* Visualizer container */
    #visualizer-wrap {
      margin-top: 24px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 14px;
    }
    #visualizer-canvas {
      width: 100%;
      height: 260px;
      display: block;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(7,10,15,0.6), rgba(7,10,15,0.2));
    }

    .vis-controls {
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      margin-bottom:10px;
    }

    @media (max-width: 768px) {
      .controls { 
        grid-template-columns: 1fr; 
      }
      header { 
        flex-direction: column; 
        align-items: flex-start; 
      }
      h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üåå Brian Eno es mi Pastor</h1>
    </div>
    <div class="big-actions">
      <button id="playBtn" class="main">‚ñ∂ Iniciar</button>
      <button id="stopBtn" class="main">‚ñ† Detener</button>
      <button id="resetBtn" class="main">‚Ü∫ Reset</button>
    </div>
  </header>

  <section class="controls">
    <div class="panel">
      <h3>üéµ Capas Musicales</h3>
      <div id="s-drone" class="slider-row">
        <label>Drone</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
      <div id="s-pads" class="slider-row">
        <label>Pads</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
      <div id="s-bells" class="slider-row">
        <label>Bells</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
      <div id="s-plucks" class="slider-row">
        <label>Plucks</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
    </div>

    <div class="panel">
      <h3>üåø Naturaleza</h3>
      <div id="s-wind" class="slider-row">
        <label>Viento</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
      <div id="s-water" class="slider-row">
        <label>Agua</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
      <div id="s-birds" class="slider-row">
        <label>P√°jaros</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>

      <hr>

      <div id="s-master" class="slider-row">
        <label>üîä Master</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
    </div>

    <div class="panel">
      <h3>‚öôÔ∏è Efectos y Control</h3>
      <div id="s-reverb-wet" class="slider-row">
        <label>Reverb Mix</label>
        <input type="range" min="0" max="100" step="1">
        <div class="value"></div>
      </div>
      <div id="s-reverb-decay" class="slider-row">
        <label>Reverb Decay</label>
        <input type="range" min="1" max="30" step="1">
        <div class="value"></div>
      </div>
      <div id="s-bpm" class="slider-row">
        <label>BPM</label>
        <input type="range" min="20" max="140" step="1">
        <div class="value"></div>
      </div>

      <hr>

      <div id="s-density" class="slider-row">
        <label>Densidad</label>
        <input type="range" min="0" max="100" step="1">
        <div class="value"></div>
      </div>
      <div id="s-prob-pluck" class="slider-row">
        <label>Prob. Plucks</label>
        <input type="range" min="0" max="100" step="1">
        <div class="value"></div>
      </div>
      <div id="s-prob-birds" class="slider-row">
        <label>Prob. P√°jaros</label>
        <input type="range" min="0" max="100" step="1">
        <div class="value"></div>
      </div>
    </div>
  </section>

  <!-- VISUALIZER SECTION (integrado) -->
  <section id="visualizer-wrap">
    <div class="vis-controls">
      <div style="flex:1;"></div>
      <label style="color:var(--muted);">Modo:</label>
      <select id="vis-select" style="padding:6px; border-radius:6px;">
        <option value="rainbow">üåà Multicolor</option>
        <option value="bubbles">ü´ß Burbujas (reverb)</option>
        <option value="lines">‚ö° L√≠neas</option>
      </select>
    </div>
    <canvas id="visualizer-canvas"></canvas>
  </section>

  <footer>
    <p>üí´Generador Ambient Infinito</p>
  </footer>

  <script>
    // Conectar selector UI con la funci√≥n setVisMode definida arriba
    document.getElementById("vis-select").addEventListener("change", (e) => {
      setVisMode(e.target.value);
    });

    // Asegurar que canvas tenga tama√±o correcto en load
    window.addEventListener("load", () => {
      const cvs = document.getElementById("visualizer-canvas");
      // dar un tama√±o base via CSS ya fijado; initVisualizer se encargar√° del DPR/resizing
    });
  </script>
</body>
</html>
