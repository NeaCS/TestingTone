<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Generador Ambient Infinito</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <script>
    let running = false;
    let audioContext;
    let synths = {};
    let noises = {};
    let volumes = {};
    let filters = {};
    let reverb;
    let timeouts = [];

    const state = {
      volumes: { drone: 0.3, pads: 0.2, bells: 0.15, plucks: 0.1, wind: 0.15, water: 0.12, birds: 0.08, master: 0.5 },
      reverbWet: 0.9,
      reverbDecay: 14,
      bpm: 55,
      density: 50,
      probPluck: 30,
      probBirds: 20,
      padBrightness: 40,
      globalLowpass: 20000
    };

    const scale = ["C3","D#3","F3","G3","A#3","C4","D#4","F4"];

    function randFrom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function densityMultiplier() {
      const d = state.density / 100;
      return 2.0 - 1.7 * d;
    }

    function dbToLinear(db) {
      return Math.pow(10, db / 20);
    }

    async function initAudio() {
      audioContext = Tone.context;
      
      // Reverb
      reverb = new Tone.Reverb({
        decay: state.reverbDecay,
        wet: state.reverbWet
      }).toDestination();
      await reverb.generate();

      // Drone
      synths.drone = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 8, release: 8 }
      }).connect(reverb);

      // Pads
      synths.pads = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sine" },
        envelope: { attack: 5, release: 8 }
      }).connect(reverb);

      // Bells
      synths.bells = new Tone.MetalSynth({
        frequency: 200,
        envelope: { attack: 0.001, decay: 1, release: 3 },
        harmonicity: 5.1,
        modulationIndex: 32,
        resonance: 4000,
        octaves: 1.5
      }).connect(reverb);

      // Plucks
      synths.plucks = new Tone.PluckSynth({
        attackNoise: 1,
        dampening: 4000,
        resonance: 0.7
      }).connect(reverb);

      // Wind (ruido rosa filtrado)
      noises.wind = new Tone.Noise("pink").start();
      filters.wind = new Tone.Filter({
        type: "lowpass",
        frequency: 800,
        rolloff: -24
      }).connect(reverb);
      noises.wind.connect(filters.wind);
      noises.wind.volume.value = -20;

      // Water (ruido filtrado)
      noises.water = new Tone.Noise("pink").start();
      filters.water = new Tone.Filter({
        type: "bandpass",
        frequency: 1500,
        Q: 3
      }).connect(reverb);
      noises.water.connect(filters.water);
      noises.water.volume.value = -22;

      // Birds synth
      synths.birds = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.4 }
      }).connect(reverb);

      // Vol√∫menes iniciales
      synths.drone.volume.value = Tone.gainToDb(state.volumes.drone);
      synths.pads.volume.value = Tone.gainToDb(state.volumes.pads);
      synths.bells.volume.value = Tone.gainToDb(state.volumes.bells);
      synths.plucks.volume.value = Tone.gainToDb(state.volumes.plucks);
      synths.birds.volume.value = Tone.gainToDb(state.volumes.birds);
      noises.wind.volume.value = Tone.gainToDb(state.volumes.wind);
      noises.water.volume.value = Tone.gainToDb(state.volumes.water);
      
      Tone.Master.volume.value = Tone.gainToDb(state.volumes.master);
    }

    function playDrone() {
      if (!running || !synths.drone) return;
      synths.drone.triggerAttack("C2");
    }

    function playRandomPad() {
      if (!running) return;
      const howMany = 1 + Math.floor(Math.random() * 3);
      const notes = Array.from({length: howMany}, () => randFrom(scale));
      const dur = Math.max(4, Math.round(12 * densityMultiplier()));
      synths.pads.triggerAttackRelease(notes, dur);
      
      const next = (10 + Math.random() * 10) * densityMultiplier() * 1000;
      timeouts.push(setTimeout(playRandomPad, next));
    }

    function playRandomBell() {
      if (!running) return;
      const note = randFrom(scale);
      const freq = Tone.Frequency(note).toFrequency();
      synths.bells.frequency.value = freq;
      synths.bells.triggerAttackRelease(0.3);
      
      const next = (8 + Math.random() * 12) * densityMultiplier() * 1000;
      timeouts.push(setTimeout(playRandomBell, next));
    }

    function playRandomPluck() {
      if (!running) return;
      if (Math.random() * 100 < state.probPluck) {
        const note = randFrom(scale);
        synths.plucks.triggerAttack(note);
      }
      const next = (4 + Math.random() * 6) * densityMultiplier() * 1000;
      timeouts.push(setTimeout(playRandomPluck, next));
    }

    function playRandomBirds() {
      if (!running) return;
      if (Math.random() * 100 < state.probBirds) {
        const freq = 1000 + Math.random() * 2000;
        synths.birds.triggerAttackRelease(freq, "16n");
      }
      const next = (10 + Math.random() * 20) * densityMultiplier() * 1000;
      timeouts.push(setTimeout(playRandomBirds, next));
    }

    async function startAmbient() {
      if (running) return;
      
      await Tone.start();
      
      if (!synths.drone) {
        await initAudio();
      }
      
      running = true;
      document.getElementById("playBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;

      Tone.Transport.bpm.value = state.bpm;
      
      playDrone();
      playRandomPad();
      playRandomBell();
      playRandomPluck();
      playRandomBirds();
      
      Tone.Transport.start();
    }

    function stopAmbient() {
      if (!running) return;
      running = false;
      
      document.getElementById("playBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;

      timeouts.forEach(t => clearTimeout(t));
      timeouts = [];

      try { Tone.Transport.stop(); } catch(e) {}
      try { synths.drone.triggerRelease(); } catch(e) {}
      try { synths.pads.releaseAll(); } catch(e) {}
    }

    function setupSlider(id, callback, initValue) {
      const container = document.getElementById(id);
      const slider = container.querySelector("input");
      const display = container.querySelector(".value");
      
      slider.value = initValue;
      display.textContent = initValue;
      
      slider.addEventListener("input", (e) => {
        const val = parseFloat(e.target.value);
        display.textContent = val;
        callback(val);
      });
    }

    function setupUI() {
      // Vol√∫menes (0-1 linear)
      setupSlider("s-drone", (v) => {
        state.volumes.drone = v;
        if (synths.drone) synths.drone.volume.value = Tone.gainToDb(v);
      }, state.volumes.drone);

      setupSlider("s-pads", (v) => {
        state.volumes.pads = v;
        if (synths.pads) synths.pads.volume.value = Tone.gainToDb(v);
      }, state.volumes.pads);

      setupSlider("s-bells", (v) => {
        state.volumes.bells = v;
        if (synths.bells) synths.bells.volume.value = Tone.gainToDb(v);
      }, state.volumes.bells);

      setupSlider("s-plucks", (v) => {
        state.volumes.plucks = v;
        if (synths.plucks) synths.plucks.volume.value = Tone.gainToDb(v);
      }, state.volumes.plucks);

      setupSlider("s-wind", (v) => {
        state.volumes.wind = v;
        if (noises.wind) noises.wind.volume.value = Tone.gainToDb(v);
      }, state.volumes.wind);

      setupSlider("s-water", (v) => {
        state.volumes.water = v;
        if (noises.water) noises.water.volume.value = Tone.gainToDb(v);
      }, state.volumes.water);

      setupSlider("s-birds", (v) => {
        state.volumes.birds = v;
        if (synths.birds) synths.birds.volume.value = Tone.gainToDb(v);
      }, state.volumes.birds);

      setupSlider("s-master", (v) => {
        state.volumes.master = v;
        Tone.Master.volume.value = Tone.gainToDb(v);
      }, state.volumes.master);

      // Reverb
      setupSlider("s-reverb-wet", (v) => {
        state.reverbWet = v / 100;
        if (reverb) reverb.wet.value = state.reverbWet;
      }, state.reverbWet * 100);

      setupSlider("s-reverb-decay", (v) => {
        state.reverbDecay = v;
        if (reverb) reverb.decay = state.reverbDecay;
      }, state.reverbDecay);

      // Tempo
      setupSlider("s-bpm", (v) => {
        state.bpm = v;
        Tone.Transport.bpm.value = state.bpm;
      }, state.bpm);

      // Density
      setupSlider("s-density", (v) => {
        state.density = v;
      }, state.density);

      // Probabilidades
      setupSlider("s-prob-pluck", (v) => {
        state.probPluck = v;
      }, state.probPluck);

      setupSlider("s-prob-birds", (v) => {
        state.probBirds = v;
      }, state.probBirds);

      // Botones
      document.getElementById("playBtn").addEventListener("click", startAmbient);
      document.getElementById("stopBtn").addEventListener("click", stopAmbient);
      document.getElementById("resetBtn").addEventListener("click", () => location.reload());
    }

    window.addEventListener("DOMContentLoaded", () => {
      setupUI();
      document.getElementById("stopBtn").disabled = true;
    });
  </script>

  <style>
    :root {
      --bg: #07070a;
      --accent: #6ee7b7;
      --muted: #9aa5b1;
      --text: #e6eef3;
    }
    body {
      margin: 0;
      padding: 20px;
      background: radial-gradient(circle at 10% 10%, #071123 0%, var(--bg) 40%);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    h1 { 
      font-size: 24px; 
      margin: 0;
      background: linear-gradient(135deg, var(--accent), #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    p.lead { 
      margin: 4px 0 0 0; 
      color: var(--muted); 
      font-size: 14px; 
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .panel {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    .panel h3 { 
      margin: 0 0 16px 0; 
      font-size: 15px; 
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .slider-row label { 
      min-width: 110px; 
      font-size: 13px; 
      color: var(--muted); 
    }

    .slider-row input[type=range] { 
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: rgba(255,255,255,0.1);
      outline: none;
      -webkit-appearance: none;
    }

    .slider-row input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(110, 231, 183, 0.4);
    }

    .slider-row input[type=range]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(110, 231, 183, 0.4);
    }

    .slider-row .value { 
      min-width: 50px; 
      text-align: right; 
      font-family: 'Courier New', monospace; 
      font-size: 13px; 
      color: var(--text);
      font-weight: 600;
    }

    .big-actions {
      display: flex;
      gap: 10px;
    }

    button.main {
      padding: 12px 24px;
      background: linear-gradient(135deg, #16324a, #0f2330);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    button.main:hover:not(:disabled) {
      background: linear-gradient(135deg, #1e3f5a, #132936);
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    button.main:disabled { 
      opacity: 0.4; 
      cursor: not-allowed; 
    }

    hr {
      border: none;
      border-top: 1px solid rgba(255,255,255,0.06);
      margin: 16px 0;
    }

    footer { 
      margin-top: 24px; 
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.06);
      color: var(--muted); 
      font-size: 13px;
      text-align: center;
    }

    @media (max-width: 768px) {
      .controls { 
        grid-template-columns: 1fr; 
      }
      header { 
        flex-direction: column; 
        align-items: flex-start; 
      }
      h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üåå Generador Ambient Infinito</h1>
      <p class="lead">M√∫sica generativa estilo Brian Eno con sonidos de naturaleza</p>
    </div>
    <div class="big-actions">
      <button id="playBtn" class="main">‚ñ∂ Iniciar</button>
      <button id="stopBtn" class="main">‚ñ† Detener</button>
      <button id="resetBtn" class="main">‚Ü∫ Reset</button>
    </div>
  </header>

  <section class="controls">
    <div class="panel">
      <h3>üéµ Capas Musicales</h3>
      <div id="s-drone" class="slider-row">
        <label>Drone</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
      <div id="s-pads" class="slider-row">
        <label>Pads</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
      <div id="s-bells" class="slider-row">
        <label>Bells</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
      <div id="s-plucks" class="slider-row">
        <label>Plucks</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
    </div>

    <div class="panel">
      <h3>üåø Naturaleza</h3>
      <div id="s-wind" class="slider-row">
        <label>Viento</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
      <div id="s-water" class="slider-row">
        <label>Agua</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
      <div id="s-birds" class="slider-row">
        <label>P√°jaros</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>

      <hr>

      <div id="s-master" class="slider-row">
        <label>üîä Master</label>
        <input type="range" min="0" max="1" step="0.01">
        <div class="value"></div>
      </div>
    </div>

    <div class="panel">
      <h3>‚öôÔ∏è Efectos y Control</h3>
      <div id="s-reverb-wet" class="slider-row">
        <label>Reverb Mix</label>
        <input type="range" min="0" max="100" step="1">
        <div class="value"></div>
      </div>
      <div id="s-reverb-decay" class="slider-row">
        <label>Reverb Decay</label>
        <input type="range" min="1" max="30" step="1">
        <div class="value"></div>
      </div>
      <div id="s-bpm" class="slider-row">
        <label>BPM</label>
        <input type="range" min="20" max="140" step="1">
        <div class="value"></div>
      </div>

      <hr>

      <div id="s-density" class="slider-row">
        <label>Densidad</label>
        <input type="range" min="0" max="100" step="1">
        <div class="value"></div>
      </div>
      <div id="s-prob-pluck" class="slider-row">
        <label>Prob. Plucks</label>
        <input type="range" min="0" max="100" step="1">
        <div class="value"></div>
      </div>
      <div id="s-prob-birds" class="slider-row">
        <label>Prob. P√°jaros</label>
        <input type="range" min="0" max="100" step="1">
        <div class="value"></div>
      </div>
    </div>
  </section>

  <footer>
    <p>üí´ Creado para Naldi ‚Äî Generador Ambient Infinito</p>
  </footer>
</body>
</html>